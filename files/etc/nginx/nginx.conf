user               nobody nogroup;
include            /etc/nginx/firstlevel.d/*.conf;
error_log          /var/log/nginx/error.log info;
pid                /var/run/nginx.pid;

#include /usr/share/nginx/modules-available/mod-stream.conf;
include /etc/nginx/module.d/ngx_stream.module;

events {
    include /etc/nginx/events.d/*.conf;
}


stream {
    # JSON logging
    log_format stream_json_full escape=json
    '{'
      '"msec":"$msec",'
      '"time_local":"$time_local",'
      '"remote_addr":"$remote_addr",'
      '"ssl_preread_server_name":"$ssl_preread_server_name",'
      '"ssl_server_name":"$ssl_server_name",'
      '"upstream_addr":"$upstream_addr",'
      '"protocol":"$protocol",'
      '"status": "$status",'
      '"bytes_sent":"$bytes_sent",'
      '"bytes_received":"$bytes_received",'
      '"session_time":"$session_time"'
    '}';

    access_log /var/log/nginx/stream.json.log stream_json_full;
    map_hash_bucket_size 256;
    variables_hash_bucket_size 256;

    include /etc/nginx/stream.maps.d/*.conf;
    include /etc/nginx/stream.upstream.d/*.conf;
    include /etc/nginx/stream.d/*.conf;
}

http {
    include /etc/nginx/buffers.d/*.conf;
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    '$status $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for" "$host" $upstream_addr '
    '$upstream_response_length $upstream_response_time $upstream_status $upstream_http_x_me_backend '
    '"$ssl_protocol" "$ssl_cipher" '
    '"BackEnd:$upstream_http_x_me_backend" "old:$sent_http_xmeold"';

    log_format  tlsclient  '$remote_addr - $remote_user [$time_local] "$request" '
    '$status $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for" "$host" $upstream_addr '
    '$upstream_response_length $upstream_response_time $upstream_status $upstream_http_x_me_backend '
    '"$ssl_protocol" "$ssl_cipher" '
    '"BackEnd:$upstream_http_x_me_backend" "old:$sent_http_xmeold" '
    '"TLS_CLIENT_VERIFY:$ssl_client_verify" '
    '"TLS_CLIENT_ISSUER_DN:$ssl_client_i_dn" '
    '"TLS_CLIENT_ISSUER_DN_LEG:$ssl_client_i_dn_legacy" '
    '"TLS_CLIENT_SUBJECT_DN:$ssl_client_s_dn" '
    '"TLS_CLIENT_SUBJECT_DN_LEG:$ssl_client_s_dn_legacy" ';

    # JSON logging
    log_format json_full escape=json
    '{'
      '"msec":"$msec",'
      '"time_local":"$time_local",'
      '"remote_addr":"$remote_addr",'
      '"remote_user":"$remote_user",'
      '"r_length":"$request_length",'
      '"r_method":"$request_method",'
      '"r_uri":"$request_uri",'
      '"i_uri":"$uri",'
      '"scheme":"$scheme",'
      '"proto":"$server_protocol",'
      '"status": "$status",'
      '"b_sent":"$body_bytes_sent",'
      '"r_time":"$request_time",'
      '"referrer":"$http_referer",'
      '"user_agent":"$http_user_agent",'
      '"cookie":"$http_cookie",'
      '"req_with":"$http_x_requested_with",'
      '"origin":"$http_origin",'
      '"host":"$host",'
      '"x_fwd":"$http_x_forwarded_for",'
      '"r_accept_lang":"$http_accept_language",'
      '"u_addr":"$upstream_addr",'
      '"u_resp_length":"$upstream_response_length",'
      '"u_resp_time":"$upstream_response_time",'
      '"u_conn_time":"$upstream_connect_time",'
      '"u_head_time":"$upstream_header_time",'
      '"u_status":"$upstream_status",'
      '"ssl_proto":"$ssl_protocol",'
      '"ssl_cipher":"$ssl_cipher",'
      '"ssl_sid":"$ssl_session_id",'
      '"http2":"$http2",'
      '"gzip_ratio":"$gzip_ratio",'
      '"cache_ctrl":"$sent_http_cache_control",'
      '"cntt_type":"$sent_http_content_type",'
      '"cntt_enc":"$sent_http_content_encoding",'
      '"envoy_svctime":"$upstream_http_x_envoy_upstream_service_time",'
      '"me_powerby":"$upstream_http_x_powered_by",'
      '"me_balance":"$upstream_http_x_me_balance",'
      '"me_balance_time":"$upstream_http_x_me_balance_time",'
      '"me_backend":"$upstream_http_x_me_backend"'
    '}';

    access_log         /var/log/nginx/access_full.json.log json_full;

    sendfile           on;
    include /etc/nginx/keepalive.d/*.conf;

    ## On the fly compression.
    gzip on;
    gzip_buffers 16 8k;
    gzip_comp_level 6;
    gzip_http_version 1.1;
    gzip_min_length 10;
    gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript image/x-icon application/vnd.ms-fontobject font/opentype application/x-font-ttf;
    gzip_vary on;
    gzip_proxied any; # Compression for all requests.

    map_hash_bucket_size 128;
    server_names_hash_bucket_size 64;

    include /etc/nginx/upstream.d/*.conf;
    include /etc/nginx/maps.d/*.conf;
    include /etc/nginx/http.d/*.conf;
}
